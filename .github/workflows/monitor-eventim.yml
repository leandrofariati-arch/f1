      - name: Run monitor (detect button enabled/text)
        id: monitor
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          FORCE_NOTIFY: ${{ github.event.inputs.force_notify }}
        run: |
          set -e
          python - << 'PY'
          import asyncio, os, re, requests, time
          from playwright.async_api import async_playwright

          URL = "https://www.eventim.com.br/campaign/f1saopaulo"
          TARGET_WORDS = [r"comprar", r"buy", r"ticket", r"tickets"]

          BOT_TOKEN = os.environ["BOT_TOKEN"]
          CHAT_ID   = os.environ["CHAT_ID"]
          FORCE     = (os.environ.get("FORCE_NOTIFY","false").lower() == "true")

          UA = ("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 "
                "(KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36")

          def gh_set_output(key, val):
            with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as out:
              print(f"{key}={val}", file=out)

          def simple_parse(html: str) -> bool:
            return any(re.search(pat, html, flags=re.I) for pat in TARGET_WORDS)

          def fallback_requests() -> bool:
            try:
              r = requests.get(
                URL,
                headers={
                  "User-Agent": UA,
                  "Accept-Language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
                  "Cache-Control": "no-cache",
                },
                timeout=30,
                allow_redirects=True,
              )
              if r.status_code == 200 and r.text:
                return simple_parse(r.text)
            except Exception:
              pass
            return False

          async def detect_playwright() -> bool:
            # tenta com playwright, mas com ajustes anti HTTP/2 e UA real
            async with async_playwright() as p:
              browser = await p.chromium.launch(
                headless=True,
                args=[
                  "--disable-http2",           # evita ERR_HTTP2_PROTOCOL_ERROR
                  "--no-sandbox",
                  "--disable-dev-shm-usage",
                ],
              )
              context = await browser.new_context(
                user_agent=UA,
                locale="pt-BR",
                extra_http_headers={"Accept-Language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7"},
                ignore_https_errors=True,
                viewport={"width": 1366, "height": 768},
              )
              page = await context.new_page()

              # 1ª tentativa: DOMContentLoaded
              try:
                await page.goto(URL, wait_until="domcontentloaded", timeout=90_000)
              except Exception:
                await browser.close()
                return False

              # tenta atingir networkidle, mas sem quebrar se não der
              try:
                await page.wait_for_load_state("networkidle", timeout=20_000)
              except Exception:
                pass

              html = await page.content()
              has_text = simple_parse(html)

              # heurística de botão habilitado
              enabled = False
              for sel in ["button", "a[role=button]", "a"]:
                els = await page.locator(sel).all()
                for el in els:
                  try:
                    txt = (await el.inner_text()).strip().lower()
                  except Exception:
                    continue
                  if any(w in txt for w in ["comprar","buy","ticket","tickets"]):
                    disabled = await el.get_attribute("disabled")
                    aria     = await el.get_attribute("aria-disabled")
                    classes  = (await el.get_attribute("class") or "").lower()
                    if (disabled is None) and (aria in [None,"false"]) and ("disabled" not in classes):
                      enabled = True
                      break
                if enabled:
                  break

              await browser.close()
              return has_text or enabled

          async def main():
            if FORCE:
              gh_set_output("should_notify", "true")
              return

            # Tenta Playwright; se der erro de navegação, cai no fallback requests
            try:
              is_on = await detect_playwright()
            except Exception:
              is_on = fallback_requests()

            gh_set_output("should_notify", "true" if is_on else "false")

          asyncio.run(main())
          PY
