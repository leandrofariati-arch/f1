name: Monitor Eventim F1 (Telegram)

on:
  schedule:
    - cron: "*/5 * * * *"      # a cada 5 min
  workflow_dispatch:            # rodar manualmente
    inputs:
      force_notify:
        description: "Enviar notifica√ß√£o de teste agora?"
        required: false
        default: "false"
  push:                         # tamb√©m roda em push (ex.: quando voc√™ editar o arquivo)
    branches:
      - main

permissions:
  contents: write               # necess√°rio se voc√™ quiser commitar o state (opcional)

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (Playwright + Requests)
        run: |
          python -m pip install --upgrade pip
          pip install playwright requests
          python -m playwright install --with-deps

      - name: Run monitor (detect button enabled/text)
        id: monitor
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          FORCE_NOTIFY: ${{ github.event.inputs.force_notify }}
        run: |
          set -e
          python - << 'PY'
          import asyncio, os, re, requests, pathlib, sys
          from playwright.async_api import async_playwright

          URL = "https://www.eventim.com.br/campaign/f1saopaulo"
          STATE_FILE = pathlib.Path("state_eventim.txt")
          TARGET_WORDS = [r"comprar", r"buy", r"ticket", r"tickets"]

          BOT_TOKEN = os.environ["BOT_TOKEN"]
          CHAT_ID   = os.environ["CHAT_ID"]
          FORCE     = (os.environ.get("FORCE_NOTIFY","false").lower() == "true")

          def gh_set_output(key, val):
            with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as out:
              print(f"{key}={val}", file=out)

          async def detect():
            async with async_playwright() as p:
              browser = await p.chromium.launch(headless=True)
              page = await browser.new_page()
              await page.goto(URL, wait_until="networkidle", timeout=120_000)

              html = await page.content()
              has_text = any(re.search(pat, html, flags=re.I) for pat in TARGET_WORDS)

              enabled = False
              for sel in ["button", "a[role=button]", "a"]:
                for el in await page.locator(sel).all():
                  try:
                    txt = (await el.inner_text()).strip().lower()
                  except:
                    continue
                  if any(w in txt for w in ["comprar","buy","ticket","tickets"]):
                    disabled = await el.get_attribute("disabled")
                    aria     = await el.get_attribute("aria-disabled")
                    classes  = (await el.get_attribute("class") or "").lower()
                    if (disabled is None) and (aria in [None,"false"]) and ("disabled" not in classes):
                      enabled = True
                      break
                if enabled: break

              await browser.close()
              return has_text or enabled

          def read_prev_state():
            if STATE_FILE.exists():
              return (STATE_FILE.read_text(encoding="utf-8").strip() or "OFF")
            return "OFF"

          def write_state(value: str):
            STATE_FILE.write_text(value, encoding="utf-8")

          async def main():
            if FORCE:
              gh_set_output("should_notify", "true")
              return

            is_on = await detect()
            prev  = read_prev_state()
            now   = "ON" if is_on else "OFF"
            gh_set_output("prev_state", prev)
            gh_set_output("curr_state", now)
            gh_set_output("should_notify", "true" if (prev != now and now=="ON") else "false")
            write_state(now)

          asyncio.run(main())
          PY

      - name: (Optional) Commit state change
        if: always()
        run: |
          if git status --porcelain | grep -q "state_eventim.txt"; then
            git config user.name  "gh-actions"
            git config user.email "actions@github.com"
            git add state_eventim.txt
            git commit -m "update state_eventim.txt"
            git push
          else
            echo "State file unchanged."
          fi

      - name: Send Telegram notification
        if: steps.monitor.outputs.should_notify == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          set -e
          TEXT="üîî F1 Eventim: bot√£o COMPRAR pode estar ATIVO!\nhttps://www.eventim.com.br/campaign/f1saopaulo"
          curl -sS --get "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${TEXT}"
