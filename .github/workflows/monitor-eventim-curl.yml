name: Monitor Eventim F1 (cURL only)

on:
  schedule:
    - cron: "*/5 * * * *"   # a cada 5 min
  workflow_dispatch:        # rodar manualmente

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Fetch page over HTTP/1.1 and search for BUY/COMPRAR
        id: monitor
        env:
          URL: "https://www.eventim.com.br/campaign/f1saopaulo"
        run: |
          set -e
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"
          # baixa via HTTP/1.1 (evita bug de HTTP/2), segue redirecionamentos (-L), e salva em page.html
          curl --http1.1 -sS -L -A "$UA" -H "Accept-Language: pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7" "$URL" -o page.html
          # debug opcional:
          BYTES=$(wc -c < page.html || echo 0); echo "[debug] bytes baixados: $BYTES"
          head -n 5 page.html || true

          # procura palavras-chave no HTML bruto
          if grep -E -i -q 'comprar|buy|ticket|tickets' page.html; then
            echo "should_notify=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_notify=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Send Telegram notification
        if: steps.monitor.outputs.should_notify == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          TEXT="ðŸ”” F1 Eventim (cURL): botÃ£o COMPRAR/TICKETS detectado!\nhttps://www.eventim.com.br/campaign/f1saopaulo"
          curl -sS --get "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${TEXT}"
